<!DOCTYPE html>
<html lang="fa">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>مدیر وظایف آنلاین</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: #f2f2f2;
            padding: 20px;
            max-width: 700px;
            margin: auto;
            direction: rtl;
            font-size: 18px;
        }
        .form-header, .page-header {
            text-align: center;
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 22px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .form-header { background: #5a47d7; border-radius: 10px 10px 0 0; margin-bottom: 0; }
        .page-header { background: #2196f3; }
        input, button, textarea {
            font-family: inherit;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .task {
            background: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .jalali-date, #editTimestamp {
            font-size: 0.85em;
            color: #777;
            margin: -5px 0 10px;
            text-align: left;
        }
        #addBtn {
            position: fixed;
            left: 20px;
            bottom: 20px;
            background: #5a47d7;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 30px;
            cursor: pointer;
        }
        .task button {
            margin-top: 5px;
            margin-left: 10px;
            background: #eee;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
        }
        .progress-bar { height: 10px; background: #ccc; border-radius: 5px; overflow: hidden; margin-top: 8px; }
        .progress { height: 10px; background: #4caf50; }
        .orange-title { color: orange; }
    </style>
</head>

<body>
    <div class="page-header">لیست کارها</div>
    <div id="taskList"></div>
    <div id="taskForm" style="display:none; background: white; padding: 20px; border-radius: 0 0 10px 10px;">
        <div class="form-header">وظیفه جدید</div>
        <input id="taskTitle" type="text" placeholder="عنوان وظیفه..." />
        <textarea id="taskDetails" placeholder="توضیحات..." oninput="updateLastEdited()"></textarea>
        <div id="editTimestamp" class="jalali-date"></div>
        <label for="taskDue">تاریخ سررسید</label>
        <input id="taskDue" type="date" oninput="updateJalaliDate(this.value)" />
        <div class="jalali-date" id="jalaliDisplay"></div>
        <label for="taskProgress">پیشرفت</label>
        <input type="range" id="taskProgress" min="0" max="100" value="0" oninput="updateProgressLabel(this.value)" />
        <div class="jalali-date"><span id="progressLabel">0%</span></div>
        <button id="submitButton" onclick="addTask()">➕ افزودن وظیفه</button>
    </div>
    <button id="addBtn" onclick="toggleForm(true)">+</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDpDvuAzs_r5ZWacFIKAZXtoV0DKCjIEWw",
            authDomain: "arontasks.firebaseapp.com",
            projectId: "arontasks",
            storageBucket: "arontasks.appspot.com",
            messagingSenderId: "1027642867381",
            appId: "1:1027642867381:web:a9ef08b56de58c1dde88fc"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let tasks = [];
        let editIndex = null;

        async function loadTasksFromFirestore() {
            const querySnapshot = await getDocs(collection(db, "tasks"));
            tasks = [];
            querySnapshot.forEach(docSnap => {
                tasks.push({ ...docSnap.data(), id: docSnap.id });
            });
            renderTasks();
        }

        async function addTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const details = document.getElementById('taskDetails').value;
            const dueDate = document.getElementById('taskDue').value;
            const progress = parseInt(document.getElementById('taskProgress').value || '0');
            if (!title) return;

            const task = { title, details, dueDate, progress };

            if (editIndex !== null) {
                const taskId = tasks[editIndex].id;
                await updateDoc(doc(db, "tasks", taskId), task);
                editIndex = null;
                document.getElementById('submitButton').textContent = '➕ افزودن وظیفه';
            } else {
                await addDoc(collection(db, "tasks"), task);
            }

            resetForm();
            toggleForm(false);
            loadTasksFromFirestore();
        }

        async function deleteTask(index) {
            if (confirm("آیا مطمئن هستید؟")) {
                await deleteDoc(doc(db, "tasks", tasks[index].id));
                loadTasksFromFirestore();
            }
        }

        function renderTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            tasks.forEach((task, index) => {
                const div = document.createElement('div');
                div.className = 'task';
                div.innerHTML = `<strong>${task.title}</strong><br>
                    <p>${task.details || ''}</p>
                    ${task.dueDate ? `<small>سررسید: ${task.dueDate}</small><br>` : ''}
                    <div class="progress-bar"><div class="progress" style="width: ${task.progress}%"></div></div>
                    <small>پیشرفت: ${task.progress}%</small><br>
                    <button onclick="editTask(${index})">✏️ ویرایش</button>
                    <button onclick="deleteTask(${index})">🗑 حذف</button>`;
                list.appendChild(div);
            });
        }

        function resetForm() {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDetails').value = '';
            document.getElementById('taskDue').value = '';
            document.getElementById('taskProgress').value = 0;
            document.getElementById('progressLabel').innerText = '0%';
            document.getElementById('jalaliDisplay').innerText = '';
            document.getElementById('editTimestamp').innerText = '';
        }

        function toggleForm(show = null) {
            const form = document.getElementById('taskForm');
            const list = document.getElementById('taskList');
            form.style.display = show ? 'block' : 'none';
            list.style.display = show ? 'none' : 'block';
        }

        function updateProgressLabel(val) {
            document.getElementById('progressLabel').innerText = val + '%';
        }

        function editTask(index) {
            const task = tasks[index];
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDetails').value = task.details;
            document.getElementById('taskDue').value = task.dueDate;
            document.getElementById('taskProgress').value = task.progress;
            updateProgressLabel(task.progress);
            editIndex = index;
            document.getElementById('submitButton').textContent = 'ذخیره تغییرات';
            toggleForm(true);
        }

        loadTasksFromFirestore();
    </script>
</body>
</html>
