<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø¯ÛŒØ± ÙˆØ¸Ø§ÛŒÙ Ø§Ø´ØªØ±Ø§Ú©ÛŒ</title>
  <style>
    body { font-family: sans-serif; direction: rtl; background: #f2f2f2; max-width: 700px; margin: auto; padding: 20px; }
    input, button, textarea { width: 100%; margin: 10px 0; padding: 10px; font-size: 16px; }
    .task { background: white; margin: 10px 0; padding: 10px; border-radius: 8px; }
    button.action { background: #ddd; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    #loginForm, #taskForm { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    .hidden { display: none; }
    .progress-bar { height: 10px; background: #ccc; border-radius: 5px; overflow: hidden; }
    .progress { height: 10px; background: #4caf50; }
  </style>
</head>
<body>
  <div id="loginForm">
    <h3>ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø¬Ø§Ø²</h3>
    <input type="email" id="email" placeholder="Ø§ÛŒÙ…ÛŒÙ„">
    <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
    <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
    <p id="loginError" style="color: red;"></p>
  </div>

  <div id="mainApp" class="hidden">
    <h2>Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¸Ø§ÛŒÙ</h2>
    <div id="taskForm">
      <input id="taskTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙˆØ¸ÛŒÙÙ‡">
      <textarea id="taskDetails" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª"></textarea>
      <input type="date" id="taskDue">
      <input type="range" id="taskProgress" min="0" max="100" value="0" oninput="updateProgressLabel(this.value)">
      <div id="progressLabel">Ù¾ÛŒØ´Ø±ÙØª: 0%</div>
      <button onclick="addOrEditTask()" id="submitButton">â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ¸ÛŒÙÙ‡</button>
    </div>
    <div id="taskList"></div>
    <button onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDpDvuAzs_r5ZWacFIKAZXtoV0DKCjIEWw",
      authDomain: "arontasks.firebaseapp.com",
      projectId: "arontasks",
      storageBucket: "arontasks.appspot.com",
      messagingSenderId: "1027642867381",
      appId: "1:1027642867381:web:a9ef08b56de58c1dde88fc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const allowedUsers = ["user1@example.com", "user2@example.com", "user3@example.com"];
    let editId = null;

    document.getElementById('taskProgress').addEventListener('input', (e) => updateProgressLabel(e.target.value));

    function updateProgressLabel(val) {
      document.getElementById('progressLabel').innerText = `Ù¾ÛŒØ´Ø±ÙØª: ${val}%`;
    }

    window.login = function() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          if (!allowedUsers.includes(user.email)) {
            document.getElementById('loginError').innerText = 'Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª';
            signOut(auth);
          }
        })
        .catch((error) => {
          document.getElementById('loginError').innerText = 'ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚. Ø§ÛŒÙ…ÛŒÙ„ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª';
        });
    };

    window.logout = function() {
      signOut(auth);
    };

    onAuthStateChanged(auth, (user) => {
      if (user && allowedUsers.includes(user.email)) {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        loadTasks();
      } else {
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
      }
    });

    async function loadTasks() {
      const taskList = document.getElementById('taskList');
      taskList.innerHTML = '';
      onSnapshot(collection(db, 'tasks'), (snapshot) => {
        taskList.innerHTML = '';
        snapshot.forEach(docSnap => {
          const task = docSnap.data();
          const div = document.createElement('div');
          div.className = 'task';
          div.innerHTML = `<strong>${task.title}</strong><br>
            <p>${task.details}</p>
            <p>Ø³Ø±Ø±Ø³ÛŒØ¯: ${task.dueDate}</p>
            <div class='progress-bar'><div class='progress' style='width: ${task.progress}%'></div></div>
            <p>Ù¾ÛŒØ´Ø±ÙØª: ${task.progress}%</p>
            <button class='action' onclick="editTask('${docSnap.id}', ${task.progress}, '${task.title}', '${task.details}', '${task.dueDate}')">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
            <button class='action' onclick="deleteTask('${docSnap.id}')">ğŸ—‘ Ø­Ø°Ù</button>`;
          taskList.appendChild(div);
        });
      });
    }

    window.addOrEditTask = async function() {
      const title = document.getElementById('taskTitle').value;
      const details = document.getElementById('taskDetails').value;
      const dueDate = document.getElementById('taskDue').value;
      const progress = parseInt(document.getElementById('taskProgress').value || '0');

      const task = { title, details, dueDate, progress };

      if (editId) {
        await updateDoc(doc(db, 'tasks', editId), task);
        editId = null;
        document.getElementById('submitButton').innerText = 'â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ¸ÛŒÙÙ‡';
      } else {
        await addDoc(collection(db, 'tasks'), task);
      }

      document.getElementById('taskTitle').value = '';
      document.getElementById('taskDetails').value = '';
      document.getElementById('taskDue').value = '';
      document.getElementById('taskProgress').value = 0;
      updateProgressLabel(0);
    }

    window.editTask = function(id, progress, title, details, dueDate) {
      editId = id;
      document.getElementById('taskTitle').value = title;
      document.getElementById('taskDetails').value = details;
      document.getElementById('taskDue').value = dueDate;
      document.getElementById('taskProgress').value = progress;
      updateProgressLabel(progress);
      document.getElementById('submitButton').innerText = 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
    }

    window.deleteTask = async function(id) {
      if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
        await deleteDoc(doc(db, 'tasks', id));
      }
    }
  </script>
</body>
</html>
